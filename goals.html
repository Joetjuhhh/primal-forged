<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Missie Tracker â€” Primal Forged</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: #050505; color: #fafafa; padding: 20px; line-height: 1.5; }
    .container { max-width: 800px; margin: 0 auto; }
    nav { margin-bottom: 32px; border-bottom: 1px solid #1c1c1c; padding-bottom: 10px; }
    nav ul { list-style: none; display: flex; gap: 20px; }
    nav a { color: #525252; text-decoration: none; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; transition: 0.3s; }
    nav a:hover { color: #7f1d1d; }
    nav a.active { color: #fafafa; border-bottom: 1px solid #7f1d1d; padding-bottom: 10px; }
    .label { font-size: 10px; color: #7f1d1d; text-transform: uppercase; letter-spacing: 0.25em; margin-bottom: 6px; font-weight: 600; }
    h1 { font-size: 26px; font-weight: 300; letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 32px; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-mini { text-align: center; padding: 16px; background: #0a0a0a; border: 1px solid #1c1c1c; }
    .stat-mini-value { font-size: 20px; font-weight: 300; }
    .stat-mini-label { font-size: 9px; color: #525252; text-transform: uppercase; margin-top: 4px; }
    .tabs { display: flex; gap: 0; border-bottom: 1px solid #1c1c1c; margin-bottom: 24px; }
    .tab { padding: 12px 24px; background: transparent; border: none; color: #525252; font-size: 11px; text-transform: uppercase; cursor: pointer; font-family: inherit; border-bottom: 2px solid transparent; margin-bottom: -1px; }
    .tab.active { color: #fafafa; border-bottom-color: #7f1d1d; }
    .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .filter-btn { padding: 8px 16px; background: #0a0a0a; border: 1px solid #1c1c1c; color: #525252; font-size: 10px; text-transform: uppercase; cursor: pointer; font-family: inherit; }
    .filter-btn.active { background: #7f1d1d; color: #fafafa; border-color: #7f1d1d; }
    .btn { padding: 14px 32px; border: none; font-size: 10px; font-weight: 500; cursor: pointer; text-transform: uppercase; font-family: inherit; background: #7f1d1d; color: #fff; }
    .btn-secondary { background: transparent; border: 1px solid #262626; color: #737373; }
    .goal-card { background: #0a0a0a; border: 1px solid #1c1c1c; margin-bottom: 12px; }
    .goal-header { padding: 20px; display: flex; gap: 16px; }
    .goal-content { flex: 1; }
    .goal-title { font-size: 14px; font-weight: 500; }
    .goal-meta { font-size: 11px; color: #525252; display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #0a0a0a; border: 1px solid #1c1c1c; max-width: 600px; width: 100%; padding: 32px; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 24px; }
    .modal-title { font-size: 18px; font-weight: 500; }
    .modal-close { background: none; border: none; color: #737373; font-size: 24px; cursor: pointer; }
    input, select, textarea { width: 100%; padding: 12px; background: #050505; border: 1px solid #1c1c1c; color: #fafafa; margin-bottom: 10px; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #7f1d1d; }
    textarea { min-height: 80px; resize: vertical; }
    .loading { text-align: center; padding: 32px; color: #525252; font-size: 12px; }
    .empty-state { text-align: center; padding: 48px 24px; color: #525252; }
    .text-success { color: #22c55e; }
    .text-warning { color: #eab308; }
    .text-accent { color: #7f1d1d; }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="body.html">Lichaam</a></li>
        <li><a href="challenges.html">Challenges</a></li>
        <li><a href="goals.html" class="active">Missies</a></li>
      </ul>
    </nav>

    <div class="label">Discipline boven Motivatie</div>
    <h1>Missie Tracker</h1>
    
    <div class="stats-row">
      <div class="stat-mini">
        <div class="stat-mini-value" id="stat-active">-</div>
        <div class="stat-mini-label">Actief</div>
      </div>
      <div class="stat-mini">
        <div class="stat-mini-value text-success" id="stat-completed">-</div>
        <div class="stat-mini-label">Voltooid</div>
      </div>
      <div class="stat-mini">
        <div class="stat-mini-value text-warning" id="stat-progress">-</div>
        <div class="stat-mini-label">Gem. Progressie</div>
      </div>
      <div class="stat-mini">
        <div class="stat-mini-value text-accent" id="stat-streak">-</div>
        <div class="stat-mini-label">Beste Streak</div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" data-tab="short">Korte termijn</button>
      <button class="tab" data-tab="medium">Middellang</button>
      <button class="tab" data-tab="long">Lange termijn</button>
      <button class="tab" data-tab="completed">Voltooid</button>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-domain="all">Alle</button>
      <button class="filter-btn" data-domain="physical">ðŸ’ª Fysiek</button>
      <button class="filter-btn" data-domain="mental">ðŸ§  Mentaal</button>
      <button class="filter-btn" data-domain="financial">ðŸ’° Financieel</button>
      <button class="filter-btn" data-domain="social">ðŸ‘¥ Sociaal</button>
      <button class="filter-btn" data-domain="purpose">ðŸ”± Zingeving</button>
    </div>
    
    <div style="margin-bottom: 24px;">
      <button class="btn" onclick="openAddModal()" style="width: 100%;">+ Nieuwe Missie Initialiseren</button>
    </div>

    <div id="goals-container">
      <div class="loading">Missies laden...</div>
    </div>
  </div>

  <div class="modal" id="goal-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Nieuwe Missie Initialiseren</div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <input type="text" id="goal-title" placeholder="Wat is je missie? (wees specifiek)">
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <select id="goal-domain">
          <option value="">Domein...</option>
          <option value="physical">ðŸ’ª Fysiek</option>
          <option value="mental">ðŸ§  Mentaal</option>
          <option value="financial">ðŸ’° Financieel</option>
          <option value="social">ðŸ‘¥ Sociaal</option>
          <option value="purpose">ðŸ”± Zingeving</option>
        </select>
        <input type="text" id="goal-subdomain" placeholder="Subdomein (optioneel)">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
        <select id="goal-priority">
          <option value="">Prioriteit...</option>
          <option value="high">ðŸ”´ Hoog</option>
          <option value="medium">ðŸŸ¡ Medium</option>
          <option value="low">ðŸŸ¢ Laag</option>
        </select>
        <select id="goal-timeframe">
          <option value="">Termijn...</option>
          <option value="short">Korte termijn</option>
          <option value="medium">Middellang</option>
          <option value="long">Lange termijn</option>
        </select>
        <input type="date" id="goal-deadline">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
        <input type="number" id="goal-start" placeholder="Start waarde" step="0.1">
        <input type="number" id="goal-current" placeholder="Huidige waarde" step="0.1">
        <input type="number" id="goal-target" placeholder="Doel waarde" step="0.1">
      </div>

      <textarea id="goal-notes" placeholder="Notities (optioneel)"></textarea>

      <div style="display: flex; gap: 12px;">
        <button class="btn" onclick="saveGoal()" style="flex: 1;">Opslaan</button>
        <button class="btn btn-secondary" onclick="closeModal()">Annuleren</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://dgqfvyjgtkoeiyswgngs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRncWZ2eWpndGtvZWl5c3dnbmdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MzIxMzgsImV4cCI6MjA1MTQwODEzOH0.5y_TE3wv6EcYzhTv_LYvbPmh2OMTOBCugdxkJG_fOus';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Global State
    let currentTab = 'short';
    let currentDomain = 'all';
    let editingGoalId = null;
    let userId = null;
    
    // Domain labels
    const domainIcons = {
      physical: 'ðŸ’ª',
      mental: 'ðŸ§ ',
      financial: 'ðŸ’°',
      social: 'ðŸ‘¥',
      purpose: 'ðŸ”±'
    };
    
    const domainNames = {
      physical: 'Fysiek',
      mental: 'Mentaal',
      financial: 'Financieel',
      social: 'Sociaal',
      purpose: 'Zingeving'
    };
    
    // Initialize
    async function init() {
      console.log('Initializing...');
      
      const { data: { user } } = await sb.auth.getUser();
      
      if (!user) {
        console.log('No user found, redirecting to login');
        window.location.href = 'login.html';
        return;
      }
      
      console.log('User found:', user.id);
      userId = user.id;
      
      setupTabs();
      setupFilters();
      loadGoals();
    }
    
    // Setup Tabs
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentTab = tab.dataset.tab;
          loadGoals();
        });
      });
    }
    
    // Setup Filters
    function setupFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentDomain = btn.dataset.domain;
          loadGoals();
        });
      });
    }
    
    // Load Goals
    async function loadGoals() {
      console.log('Loading goals for tab:', currentTab, 'domain:', currentDomain);
      const container = document.getElementById('goals-container');
      container.innerHTML = '<div class="loading">Missies laden...</div>';
      
      try {
        let query = sb
          .from('goals')
          .select('*')
          .eq('user_id', userId)
          .order('created_at', { ascending: false });
        
        if (currentTab === 'completed') {
          query = query.eq('is_completed', true);
        } else {
          query = query.eq('is_completed', false).eq('timeframe', currentTab);
        }
        
        if (currentDomain !== 'all') {
          query = query.eq('domain', currentDomain);
        }
        
        const { data: goals, error } = await query;
        
        if (error) {
          console.error('Error loading goals:', error);
          throw error;
        }
        
        console.log('Goals loaded:', goals);
        
        if (!goals || goals.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div style="font-size: 48px; margin-bottom: 16px;">ðŸŽ¯</div>
              <div style="font-size: 14px; margin-bottom: 16px;">Nog geen missies in deze categorie</div>
              <button class="btn" onclick="openAddModal()">+ Eerste Missie Toevoegen</button>
            </div>
          `;
        } else {
          container.innerHTML = goals.map(goal => renderGoalCard(goal)).join('');
        }
        
        updateStats();
      } catch (error) {
        console.error('Error in loadGoals:', error);
        container.innerHTML = '<div class="loading">Fout bij laden: ' + error.message + '</div>';
      }
    }
    
    // Render Goal Card
    function renderGoalCard(goal) {
      return `
        <div class="goal-card">
          <div class="goal-header">
            <div class="goal-content">
              <div class="goal-title">${goal.title}</div>
              <div class="goal-meta">
                ${goal.domain ? `<span>${domainIcons[goal.domain]} ${domainNames[goal.domain]}</span>` : ''}
                ${goal.subdomain ? `<span>â†’ ${goal.subdomain}</span>` : ''}
                ${goal.deadline ? `<span>ðŸ“… ${formatDate(goal.deadline)}</span>` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Format Date
    function formatDate(dateString) {
      const date = new Date(dateString);
      const day = date.getDate();
      const month = date.toLocaleString('nl-NL', { month: 'short' });
      return `${day} ${month}`;
    }
    
    // Update Stats
    async function updateStats() {
      try {
        const { data: allGoals } = await sb
          .from('goals')
          .select('*')
          .eq('user_id', userId);
        
        if (!allGoals) return;
        
        const active = allGoals.filter(g => !g.is_completed).length;
        const completed = allGoals.filter(g => g.is_completed).length;
        
        document.getElementById('stat-active').textContent = active;
        document.getElementById('stat-completed').textContent = completed;
        document.getElementById('stat-progress').textContent = '0%';
        document.getElementById('stat-streak').textContent = '0d';
      } catch (error) {
        console.error('Error updating stats:', error);
      }
    }
    
    // Open Modal
    function openAddModal() {
      console.log('Opening add modal');
      editingGoalId = null;
      document.getElementById('modal-title').textContent = 'Nieuwe Missie Initialiseren';
      document.getElementById('goal-title').value = '';
      document.getElementById('goal-domain').value = '';
      document.getElementById('goal-subdomain').value = '';
      document.getElementById('goal-priority').value = '';
      document.getElementById('goal-timeframe').value = currentTab;
      document.getElementById('goal-deadline').value = '';
      document.getElementById('goal-start').value = '';
      document.getElementById('goal-current').value = '';
      document.getElementById('goal-target').value = '';
      document.getElementById('goal-notes').value = '';
      document.getElementById('goal-modal').classList.add('active');
    }
    
    // Close Modal
    function closeModal() {
      document.getElementById('goal-modal').classList.remove('active');
    }
    
    // Save Goal
    async function saveGoal() {
      const title = document.getElementById('goal-title').value.trim();
      
      if (!title) {
        alert('Vul een titel in');
        return;
      }
      
      const goalData = {
        user_id: userId,
        title: title,
        domain: document.getElementById('goal-domain').value || null,
        subdomain: document.getElementById('goal-subdomain').value || null,
        priority: document.getElementById('goal-priority').value || null,
        timeframe: document.getElementById('goal-timeframe').value || 'short',
        deadline: document.getElementById('goal-deadline').value || null,
        start_value: parseFloat(document.getElementById('goal-start').value) || null,
        current_value: parseFloat(document.getElementById('goal-current').value) || null,
        target_value: parseFloat(document.getElementById('goal-target').value) || null,
        notes: document.getElementById('goal-notes').value || null,
        is_completed: false
      };
      
      try {
        const { error } = await sb
          .from('goals')
          .insert([goalData]);
        
        if (error) throw error;
        
        closeModal();
        loadGoals();
      } catch (error) {
        console.error('Error saving goal:', error);
        alert('Fout bij opslaan: ' + error.message);
      }
    }
    
    // Start
    console.log('Script loaded');
    init();
  </script>
</body>
</html>
