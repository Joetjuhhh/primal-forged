<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#050505">
  <title>Primal Forged</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #050505; color: #fafafa; }
    
    .loading { display: flex; align-items: center; justify-content: center; height: 100vh; }
    .loading-text { font-size: 12px; color: #525252; text-transform: uppercase; letter-spacing: 0.2em; }
    
    .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
    
    .app-header { position: fixed; top: 0; left: 0; right: 0; background: #050505; border-bottom: 1px solid #1c1c1c; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
    .logo { font-size: 10px; font-weight: 600; letter-spacing: 0.35em; }
    .logo-accent { color: #7f1d1d; margin-left: 6px; }
    .user-menu { display: flex; align-items: center; gap: 12px; }
    .user-email { font-size: 10px; color: #525252; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .logout-btn { background: transparent; border: 1px solid #1c1c1c; color: #737373; padding: 6px 12px; font-size: 9px; cursor: pointer; font-family: inherit; }
    
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
    .auth-box { width: 100%; max-width: 360px; }
    .auth-title { font-size: 24px; font-weight: 300; text-align: center; margin-bottom: 8px; letter-spacing: 0.1em; }
    .auth-subtitle { font-size: 11px; color: #525252; text-align: center; margin-bottom: 32px; }
    .auth-input { width: 100%; padding: 14px 16px; background: #0a0a0a; border: 1px solid #1c1c1c; color: #fafafa; font-size: 14px; font-family: inherit; margin-bottom: 12px; }
    .auth-input:focus { outline: none; border-color: #7f1d1d; }
    .auth-btn { width: 100%; padding: 14px; background: #7f1d1d; border: none; color: #fff; font-size: 11px; font-weight: 500; cursor: pointer; font-family: inherit; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 8px; }
    .auth-btn:hover { background: #991b1b; }
    .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .auth-switch { text-align: center; margin-top: 24px; font-size: 12px; color: #525252; }
    .auth-switch a { color: #7f1d1d; cursor: pointer; text-decoration: none; }
    .auth-error { background: rgba(220,38,38,0.1); border: 1px solid #dc2626; color: #dc2626; padding: 12px; font-size: 12px; margin-bottom: 16px; }
    .auth-success { background: rgba(34,197,94,0.1); border: 1px solid #22c55e; color: #22c55e; padding: 12px; font-size: 12px; margin-bottom: 16px; }
    
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: #0a0a0a; border-top: 1px solid #1c1c1c; display: flex; z-index: 100; }
    .nav-item { flex: 1; padding: 12px 8px; background: transparent; border: none; color: #525252; font-size: 9px; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; font-family: inherit; text-align: center; }
    .nav-item.active { color: #7f1d1d; }
    .nav-icon { font-size: 18px; display: block; margin-bottom: 4px; }
    
    .card { background: #0a0a0a; border: 1px solid #1c1c1c; padding: 20px; margin-bottom: 16px; }
    .card-accent { border-left: 3px solid #7f1d1d; }
    
    .label { font-size: 10px; color: #525252; text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 12px; font-weight: 500; display: block; }
    
    .page-header { margin-bottom: 24px; padding-top: 60px; }
    .page-sub { font-size: 10px; color: #7f1d1d; text-transform: uppercase; letter-spacing: 0.25em; margin-bottom: 6px; font-weight: 600; }
    .page-title { font-size: 26px; font-weight: 300; letter-spacing: 0.08em; text-transform: uppercase; }
    
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 24px; }
    .stat { text-align: center; padding: 16px 8px; background: #0a0a0a; border: 1px solid #1c1c1c; }
    .stat-value { font-size: 20px; font-weight: 300; }
    .stat-label { font-size: 8px; color: #525252; text-transform: uppercase; margin-top: 4px; letter-spacing: 0.05em; }
    
    .tabs { display: flex; border-bottom: 1px solid #1c1c1c; margin-bottom: 24px; overflow-x: auto; }
    .tab { padding: 12px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: #525252; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; font-family: inherit; margin-bottom: -1px; white-space: nowrap; }
    .tab.active { color: #fafafa; border-bottom-color: #7f1d1d; }
    
    .textarea { width: 100%; min-height: 150px; padding: 16px; background: #050505; border: 1px solid #1c1c1c; color: #fafafa; font-family: inherit; font-size: 14px; line-height: 1.7; resize: vertical; }
    .textarea:focus { outline: none; border-color: #7f1d1d; }
    
    .slider-group { margin-bottom: 16px; }
    .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .slider-label { font-size: 12px; color: #a3a3a3; }
    .slider-value { font-size: 14px; font-weight: 500; transition: color 0.2s; }
    .slider { 
      -webkit-appearance: none; 
      width: 100%; 
      height: 8px; 
      background: linear-gradient(to right, #dc2626, #eab308, #22c55e); 
      outline: none; 
      border-radius: 4px;
      opacity: 0.4;
    }
    .slider::-webkit-slider-thumb { 
      -webkit-appearance: none; 
      width: 22px; 
      height: 22px; 
      background: #fafafa; 
      cursor: pointer; 
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    .slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      background: #fafafa;
      cursor: pointer;
      border-radius: 50%;
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    .slider-stress {
      background: linear-gradient(to right, #22c55e, #eab308, #dc2626);
    }
    
    .tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag { padding: 10px 14px; background: transparent; border: 1px solid #1c1c1c; color: #737373; font-size: 11px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .tag:hover { border-color: #525252; }
    .tag.active { background: rgba(127,29,29,0.2); border-color: #7f1d1d; color: #fafafa; }
    
    .btn { padding: 14px 28px; border: none; font-size: 11px; font-weight: 500; cursor: pointer; font-family: inherit; text-transform: uppercase; letter-spacing: 0.1em; }
    .btn-primary { background: #7f1d1d; color: #fff; }
    .btn-primary:hover { background: #991b1b; }
    .btn-secondary { background: transparent; border: 1px solid #1c1c1c; color: #737373; }
    .btn-danger { background: #dc2626; color: #fff; }
    .btn-small { padding: 10px 16px; font-size: 10px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .entry { background: #0a0a0a; border: 1px solid #1c1c1c; padding: 20px; margin-bottom: 12px; }
    .entry-date { font-size: 11px; color: #525252; margin-bottom: 12px; }
    .entry-scores { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .entry-score { font-size: 10px; padding: 4px 8px; background: #1c1c1c; }
    .entry-content { font-size: 13px; color: #a3a3a3; line-height: 1.7; white-space: pre-wrap; }
    .entry-habits { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
    .entry-habit { font-size: 9px; padding: 4px 8px; border-radius: 2px; }
    .entry-actions { display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #1c1c1c; }
    .entry-action { background: transparent; border: 1px solid #1c1c1c; color: #737373; padding: 8px 12px; font-size: 10px; cursor: pointer; font-family: inherit; }
    .entry-action:hover { border-color: #525252; }
    .entry-action.delete { color: #dc2626; }
    
    .info-box { padding: 16px; background: rgba(127,29,29,0.1); border-left: 3px solid #7f1d1d; margin-bottom: 16px; }
    .info-title { font-size: 11px; color: #7f1d1d; margin-bottom: 6px; font-weight: 500; }
    .info-text { font-size: 12px; color: #a3a3a3; line-height: 1.6; }
    
    .prompt { padding: 16px; background: rgba(127,29,29,0.1); border-left: 3px solid #7f1d1d; margin-bottom: 16px; }
    .prompt-label { font-size: 10px; color: #7f1d1d; margin-bottom: 6px; }
    .prompt-text { font-size: 13px; color: #a3a3a3; font-style: italic; }
    
    .toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: #166534; color: #fff; padding: 12px 24px; font-size: 12px; z-index: 200; display: none; }
    .toast.show { display: block; }
    
    .empty { text-align: center; padding: 40px 20px; color: #525252; font-size: 13px; }
    
    .insight { padding: 16px; margin-bottom: 12px; display: flex; gap: 12px; align-items: flex-start; }
    .insight-positive { background: rgba(34,197,94,0.1); border-left: 3px solid #22c55e; }
    .insight-negative { background: rgba(234,179,8,0.1); border-left: 3px solid #eab308; }
    .insight-icon { font-size: 20px; }
    .insight-title { font-size: 12px; font-weight: 500; margin-bottom: 4px; }
    .insight-positive .insight-title { color: #22c55e; }
    .insight-negative .insight-title { color: #eab308; }
    .insight-text { font-size: 11px; color: #a3a3a3; }

    /* Dashboard specific */
    .greeting { font-size: 20px; font-weight: 300; margin-bottom: 4px; }
    .greeting-sub { font-size: 12px; color: #525252; margin-bottom: 24px; }
    
    .streak-big { text-align: center; padding: 32px; }
    .streak-number { font-size: 72px; font-weight: 200; line-height: 1; }
    .streak-label { font-size: 11px; color: #525252; text-transform: uppercase; letter-spacing: 0.15em; margin-top: 8px; }
    
    .habit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .habit { padding: 12px 8px; background: transparent; border: 1px solid #1c1c1c; color: #525252; cursor: pointer; font-family: inherit; text-align: center; }
    .habit.done { background: rgba(34,197,94,0.1); border-color: #22c55e; color: #22c55e; }
    .habit.done.negative { background: rgba(234,179,8,0.1); border-color: #eab308; color: #eab308; }
    .habit-icon { font-size: 18px; display: block; margin-bottom: 4px; }
    .habit-label { font-size: 8px; text-transform: uppercase; }
    
    .quote-card { padding: 20px; background: #0a0a0a; border: 1px solid #1c1c1c; margin-bottom: 16px; }
    .quote-text { font-size: 14px; color: #a3a3a3; font-style: italic; line-height: 1.6; margin-bottom: 12px; }
    .quote-author { font-size: 11px; color: #525252; }
    
    /* Retention specific */
    .phase-indicator { padding: 12px; text-align: center; margin-top: 16px; }
    .phase-name { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; }
    
    .progress-bar { height: 4px; background: #1c1c1c; margin-top: 16px; }
    .progress-fill { height: 100%; transition: width 0.3s; }
    
    .emergency-btn { width: 100%; padding: 20px; background: #dc2626; border: none; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 24px; }
    .emergency-btn:hover { background: #b91c1c; }
    
    .milestone { padding: 16px; background: #0a0a0a; border: 1px solid #1c1c1c; margin-bottom: 12px; display: flex; gap: 16px; align-items: flex-start; }
    .milestone.achieved { border-color: #22c55e; background: rgba(34,197,94,0.05); }
    .milestone-day { font-size: 24px; font-weight: 300; color: #525252; min-width: 50px; }
    .milestone.achieved .milestone-day { color: #22c55e; }
    .milestone-title { font-size: 12px; font-weight: 500; margin-bottom: 4px; }
    .milestone-desc { font-size: 11px; color: #525252; }
    
    .urge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .urge { padding: 16px 8px; background: #0a0a0a; border: 1px solid #1c1c1c; cursor: pointer; text-align: center; }
    .urge:hover { border-color: #7f1d1d; }
    .urge-icon { font-size: 24px; display: block; margin-bottom: 8px; }
    .urge-label { font-size: 9px; color: #a3a3a3; text-transform: uppercase; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal { background: #0a0a0a; border: 1px solid #1c1c1c; padding: 24px; max-width: 400px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-size: 18px; font-weight: 500; margin-bottom: 16px; color: #dc2626; }
    .modal-title.habit { color: #22c55e; }
    .modal-step { padding: 16px; background: #050505; border-left: 3px solid #dc2626; margin-bottom: 12px; }
    .modal-step.habit { border-left-color: #7f1d1d; }
    .modal-step-title { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
    .modal-step-text { font-size: 11px; color: #a3a3a3; }
    
    .habit-modal-icon { font-size: 48px; text-align: center; margin-bottom: 16px; }
    .habit-modal-duration { text-align: center; padding: 12px; background: rgba(127,29,29,0.2); border: 1px solid #7f1d1d; margin-bottom: 16px; font-size: 14px; color: #fafafa; }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <span class="loading-text">Laden...</span>
    </div>
  </div>

  <script>
    // ============================================
    // SUPABASE CONFIG
    // ============================================
    const SUPABASE_URL = 'https://dgqfvyjgtkoeiyswgngs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_rDP5Kvq0wBsObLeiXJ98OA_aa0q-ipz';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ============================================
    // APP STATE
    // ============================================
    let state = {
      user: null,
      loading: true,
      activeSection: 'dashboard',
      
      // Journal
      journalTab: 'new',
      entries: [],
      content: '',
      mood: 7,
      energy: 7,
      libido: 7,
      focus: 7,
      stress: 4,
      sleep: 7,
      editingId: null,
      
      // Retention
      retentionStreak: null,
      showEmergencyModal: false,
      showHabitModal: null,
      
      // Daily habits (positive + negative situations)
      habits: {
        coldShower: false,
        sunlight: false,
        cleanEating: false,
        workout: false,
        meditation: false,
        noAlcohol: false,
        reading: false,
        stretching: false,
        outside: false,
        // Negative/situation
        badSleep: false,
        stressed: false,
        alcohol: false,
        unhealthy: false
      }
    };

    // Constants - no more tagOptions, habits are the single source
    const habitConfig = {
      // POSITIVE HABITS
      coldShower: { 
        icon: 'üßä', 
        label: 'Koud',
        title: 'Koude Douche',
        what: 'Douchen met koud water',
        how: 'Begin lauw, laatste 30-60 seconden ijskoud. Adem rustig door.',
        why: 'Verhoogt noradrenaline 200-300% en dopamine tot 250%. Verbetert focus en wilskracht.',
        duration: '2-3 minuten koud',
        positive: true
      },
      sunlight: { 
        icon: '‚òÄÔ∏è', 
        label: 'Zon',
        title: 'Zonlicht',
        what: 'Direct zonlicht in je ogen (niet staren!)',
        how: 'Ga binnen 30 min na opstaan naar buiten. Geen zonnebril, geen raam.',
        why: 'Reguleert je circadiaans ritme, boost cortisol ochtendpiek en testosteron.',
        duration: '10-15 minuten',
        positive: true
      },
      cleanEating: { 
        icon: 'ü•ó', 
        label: 'Clean',
        title: 'Clean Eating',
        what: 'Alleen onbewerkt, natuurlijk voedsel',
        how: 'Geen processed food, geen toegevoegde suiker, geen seed oils. Vlees, vis, eieren, groenten, fruit, noten.',
        why: 'Stabiele energie, betere hormoonbalans, minder inflammatie.',
        duration: 'Hele dag',
        positive: true
      },
      workout: { 
        icon: 'üí™', 
        label: 'Sport',
        title: 'Training',
        what: 'Zware compound training of HIIT',
        how: 'Focus op squats, deadlifts, bench, rows. Progressieve overload. Of 20-30 min HIIT.',
        why: 'Verhoogt testosteron, HGH, dopamine. Bouwt discipline en zelfvertrouwen.',
        duration: '45-60 minuten',
        positive: true
      },
      meditation: { 
        icon: 'üßò', 
        label: 'Rust',
        title: 'Meditatie',
        what: 'Stille meditatie of ademhalingsoefeningen',
        how: 'Zit rechtop, ogen dicht, focus op je adem. Gedachten komen en gaan.',
        why: 'Verlaagt cortisol, verbetert focus en emotieregulatie, vergroot prefrontale cortex.',
        duration: '10-20 minuten',
        positive: true
      },
      noAlcohol: { 
        icon: 'üö´', 
        label: 'Nuchter',
        title: 'Geen Alcohol',
        what: 'Geen enkele druppel alcohol',
        how: 'Vervang met water, thee, of sparkling water met citroen.',
        why: 'Alcohol verlaagt testosteron met 20-25% voor 24-72 uur. Verstoort slaap en recovery.',
        duration: '24 uur',
        positive: true
      },
      reading: { 
        icon: 'üìñ', 
        label: 'Lezen',
        title: 'Lezen',
        what: 'Non-fictie boek lezen (zelfontwikkeling)',
        how: 'Fysiek boek, geen telefoon erbij. Maak notities.',
        why: 'Bouwt kennis, verbetert focus, vervangt dopamine-verslaving door waardevol gedrag.',
        duration: '30 minuten',
        positive: true
      },
      stretching: { 
        icon: 'ü§∏', 
        label: 'Stretch',
        title: 'Stretchen',
        what: 'Mobility en stretching routine',
        how: 'Focus op heupen, hamstrings, schouders, thoracic spine. Hold 30-60 sec per stretch.',
        why: 'Betere houding, minder blessures, ontspanning, betere bloedflow.',
        duration: '10-15 minuten',
        positive: true
      },
      outside: { 
        icon: 'üö∂', 
        label: 'Buiten',
        title: 'Buiten Geweest',
        what: 'Tijd doorgebracht in de buitenlucht',
        how: 'Wandelen, fietsen, tuinieren, of gewoon buiten zitten.',
        why: 'Frisse lucht, vitamine D, verlaagt stress, verbetert stemming.',
        duration: '30+ minuten',
        positive: true
      },
      // NEGATIVE/SITUATION
      badSleep: { 
        icon: 'üò¥', 
        label: 'Slecht',
        title: 'Slecht Geslapen',
        what: 'Slechte nachtrust gehad',
        how: 'Minder dan 6 uur, vaak wakker, niet uitgerust.',
        why: 'Track dit om patronen te ontdekken tussen slaap en je mood/energie.',
        duration: 'Vorige nacht',
        positive: false
      },
      stressed: { 
        icon: 'üò§', 
        label: 'Stress',
        title: 'Gestrest',
        what: 'Veel stress ervaren vandaag',
        how: 'Werk, relaties, financi√´n, of andere zorgen.',
        why: 'Chronische stress verlaagt testosteron en verhoogt cortisol.',
        duration: 'Vandaag',
        positive: false
      },
      alcohol: { 
        icon: 'üç∫', 
        label: 'Alcohol',
        title: 'Alcohol Gedronken',
        what: 'Alcohol geconsumeerd',
        how: 'Bier, wijn, sterke drank.',
        why: 'Track dit om de impact op je mood en energie te zien.',
        duration: 'Vandaag',
        positive: false
      },
      unhealthy: { 
        icon: 'üçî', 
        label: 'Junk',
        title: 'Ongezond Gegeten',
        what: 'Processed food of junk food gegeten',
        how: 'Fast food, snoep, chips, frisdrank, etc.',
        why: 'Track dit om de impact op je energie en focus te zien.',
        duration: 'Vandaag',
        positive: false
      }
    };

    const retentionPhases = [
      { days: 0, name: 'Opstarten', color: '#525252' },
      { days: 7, name: 'Dopamine Reset', color: '#eab308' },
      { days: 14, name: 'T-Boost', color: '#f97316' },
      { days: 30, name: 'Rewiring', color: '#22c55e' },
      { days: 60, name: 'Transformatie', color: '#3b82f6' },
      { days: 90, name: 'Meesterschap', color: '#7f1d1d' }
    ];

    const retentionMilestones = [
      { days: 7, title: 'Dopamine Receptor Upregulatie', desc: 'Je hersenen beginnen gevoeliger te worden voor natuurlijke dopamine.' },
      { days: 14, title: 'Testosteron Piek', desc: 'Onderzoek toont een piek in testosteron niveaus rond dag 7-14.' },
      { days: 30, title: 'Prefrontale Cortex Verbetering', desc: 'Betere impulse controle en besluitvorming.' },
      { days: 60, title: 'ŒîFosB Normalisatie', desc: 'De verslavings-gerelateerde prote√Ønen normaliseren.' },
      { days: 90, title: 'Neuroplastische Reset', desc: 'Significante herstel van neurale paden.' }
    ];

    const quotes = [
      { text: "De man die zijn bergen verzet, begint met het dragen van kleine stenen.", author: "Confucius" },
      { text: "Discipline is de brug tussen doelen en prestaties.", author: "Jim Rohn" },
      { text: "Je wordt niet bepaald door wat je wilt. Je wordt bepaald door wat je doet.", author: "Marcus Aurelius" },
      { text: "Elke actie die je neemt is een stem voor het type persoon dat je wilt worden.", author: "James Clear" },
      { text: "De pijn van discipline weegt grammen, de pijn van spijt weegt tonnen.", author: "Jim Rohn" }
    ];

    const dailyPrompts = [
      "Wat was je grootste overwinning gisteren?",
      "Waar ben je dankbaar voor vandaag?",
      "Wat is je belangrijkste doel voor vandaag?",
      "Welke gewoonte wil je vandaag versterken?",
      "Hoe ga je vandaag beter zijn dan gisteren?"
    ];

    const urges = [
      { icon: 'üßä', label: 'Koud water', desc: 'Neem een koude douche' },
      { icon: 'ü´Å', label: 'Ademhaling', desc: 'Box breathing: 4-4-4-4' },
      { icon: 'üèÉ', label: 'Beweeg', desc: '20 push-ups of ga wandelen' },
      { icon: 'üö™', label: 'Verlaat', desc: 'Ga naar een andere ruimte' },
      { icon: 'üìû', label: 'Bel', desc: 'Bel een vriend of familie' },
      { icon: '‚úçÔ∏è', label: 'Schrijf', desc: 'Journal je gevoel' },
      { icon: 'üßò', label: 'Mediteer', desc: '5 minuten stilte' },
      { icon: 'üìñ', label: 'Lees', desc: 'Lees je waarom' },
      { icon: '‚è±Ô∏è', label: 'Wacht', desc: '15 minuten timer' }
    ];

    // ============================================
    // HELPERS
    // ============================================
    function getColor(value, isStress = false) {
      // For stress: low is good (green), high is bad (red)
      // For others: low is bad (red), high is good (green)
      const v = isStress ? (11 - value) : value;
      
      if (v <= 2) return '#dc2626';      // Red
      if (v <= 3) return '#ea580c';      // Orange-red
      if (v <= 4) return '#f97316';      // Orange
      if (v <= 5) return '#eab308';      // Yellow
      if (v <= 6) return '#a3e635';      // Yellow-green
      if (v <= 7) return '#84cc16';      // Lime
      if (v <= 8) return '#22c55e';      // Green
      return '#16a34a';                   // Dark green
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long' });
    }

    function getGreeting() {
      const hour = new Date().getHours();
      if (hour < 12) return 'Goedemorgen';
      if (hour < 18) return 'Goedemiddag';
      return 'Goedenavond';
    }

    function getDailyQuote() {
      const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      return quotes[dayOfYear % quotes.length];
    }

    function getDailyPrompt() {
      const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      return dailyPrompts[dayOfYear % dailyPrompts.length];
    }

    function getRetentionPhase(days) {
      for (let i = retentionPhases.length - 1; i >= 0; i--) {
        if (days >= retentionPhases[i].days) return retentionPhases[i];
      }
      return retentionPhases[0];
    }

    function getNextMilestone(days) {
      return retentionMilestones.find(m => m.days > days) || retentionMilestones[retentionMilestones.length - 1];
    }

    function getAverageMood() {
      if (state.entries.length === 0) return '‚Äî';
      const sum = state.entries.reduce((a, e) => a + (e.mood || 5), 0);
      return (sum / state.entries.length).toFixed(1);
    }

    function getAverageEnergy() {
      if (state.entries.length === 0) return '‚Äî';
      const sum = state.entries.reduce((a, e) => a + (e.energy || 5), 0);
      return (sum / state.entries.length).toFixed(1);
    }

    function getJournalStreak() {
      if (state.entries.length === 0) return 0;
      let streak = 1;
      const dates = state.entries.map(e => e.date).sort().reverse();
      for (let i = 1; i < dates.length; i++) {
        const d1 = new Date(dates[i-1]);
        const d2 = new Date(dates[i]);
        const diff = (d1 - d2) / (1000 * 60 * 60 * 24);
        if (diff <= 1) streak++;
        else break;
      }
      return streak;
    }

    function getHabitsCompleted() {
      return Object.values(state.habits).filter(Boolean).length;
    }

    function getPositiveHabitsCount() {
      const positiveKeys = Object.entries(habitConfig).filter(([k, c]) => c.positive).map(([k]) => k);
      return positiveKeys.filter(k => state.habits[k]).length;
    }

    function getRetentionDays() {
      if (!state.retentionStreak || !state.retentionStreak.start_date) return 0;
      const start = new Date(state.retentionStreak.start_date);
      const now = new Date();
      return Math.floor((now - start) / (1000 * 60 * 60 * 24));
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      if (toast) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      }
    }

    function getInsights() {
      // Filter entries that have habits data
      const entriesWithHabits = state.entries.filter(e => e.habits && Object.keys(e.habits).length > 0);
      
      if (entriesWithHabits.length < 3) return [];
      
      const insights = [];
      
      // Analyze each habit's correlation with mood and energy
      Object.entries(habitConfig).forEach(([habitKey, habitCfg]) => {
        const withHabit = entriesWithHabits.filter(e => e.habits && e.habits[habitKey]);
        const withoutHabit = entriesWithHabits.filter(e => e.habits && !e.habits[habitKey]);
        
        if (withHabit.length >= 2 && withoutHabit.length >= 2) {
          const avgMoodWith = withHabit.reduce((a, e) => a + (e.mood || 5), 0) / withHabit.length;
          const avgMoodWithout = withoutHabit.reduce((a, e) => a + (e.mood || 5), 0) / withoutHabit.length;
          const avgEnergyWith = withHabit.reduce((a, e) => a + (e.energy || 5), 0) / withHabit.length;
          const avgEnergyWithout = withoutHabit.reduce((a, e) => a + (e.energy || 5), 0) / withoutHabit.length;
          
          if (habitCfg.positive) {
            // Positive habit: show if it improves mood/energy
            const moodDiff = avgMoodWith - avgMoodWithout;
            const energyDiff = avgEnergyWith - avgEnergyWithout;
            
            if (moodDiff >= 0.5) {
              insights.push({
                icon: habitCfg.icon,
                title: `${habitCfg.title} verbetert je mood`,
                text: `Met: ${avgMoodWith.toFixed(1)} | Zonder: ${avgMoodWithout.toFixed(1)} (+${moodDiff.toFixed(1)})`,
                positive: true,
                impact: moodDiff
              });
            }
            if (energyDiff >= 0.5) {
              insights.push({
                icon: habitCfg.icon,
                title: `${habitCfg.title} boost je energie`,
                text: `Met: ${avgEnergyWith.toFixed(1)} | Zonder: ${avgEnergyWithout.toFixed(1)} (+${energyDiff.toFixed(1)})`,
                positive: true,
                impact: energyDiff
              });
            }
          } else {
            // Negative habit: show if it lowers mood/energy
            const moodDiff = avgMoodWithout - avgMoodWith;
            const energyDiff = avgEnergyWithout - avgEnergyWith;
            
            if (moodDiff >= 0.5) {
              insights.push({
                icon: habitCfg.icon,
                title: `${habitCfg.title} verlaagt je mood`,
                text: `Met: ${avgMoodWith.toFixed(1)} | Zonder: ${avgMoodWithout.toFixed(1)} (-${moodDiff.toFixed(1)})`,
                positive: false,
                impact: moodDiff
              });
            }
            if (energyDiff >= 0.5) {
              insights.push({
                icon: habitCfg.icon,
                title: `${habitCfg.title} verlaagt je energie`,
                text: `Met: ${avgEnergyWith.toFixed(1)} | Zonder: ${avgEnergyWithout.toFixed(1)} (-${energyDiff.toFixed(1)})`,
                positive: false,
                impact: energyDiff
              });
            }
          }
        }
      });
      
      // Sort by impact and return top 6
      insights.sort((a, b) => (b.impact || 0) - (a.impact || 0));
      return insights.slice(0, 6);
    }

    // ============================================
    // AUTH
    // ============================================
    async function signUp(email, password) {
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if (error) throw error;
      return data;
    }

    async function signIn(email, password) {
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) throw error;
      return data;
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      state.user = null;
      state.entries = [];
      state.retentionStreak = null;
      render();
    }

    // ============================================
    // DATABASE
    // ============================================
    async function loadEntries() {
      if (!state.user) return;
      const { data, error } = await supabaseClient
        .from('journal_entries')
        .select('*')
        .eq('user_id', state.user.id)
        .order('date', { ascending: false });
      if (!error) state.entries = data || [];
    }

    async function loadRetention() {
      if (!state.user) return;
      const { data, error } = await supabaseClient
        .from('retention')
        .select('*')
        .eq('user_id', state.user.id)
        .eq('is_active', true)
        .single();
      if (!error && data) state.retentionStreak = data;
    }

    async function loadHabits() {
      if (!state.user) return;
      const today = new Date().toISOString().split('T')[0];
      const { data, error } = await supabaseClient
        .from('daily_habits')
        .select('*')
        .eq('user_id', state.user.id)
        .eq('date', today)
        .single();
      if (!error && data) {
        state.habits = {
          coldShower: data.cold_shower || false,
          sunlight: data.sunlight || false,
          cleanEating: data.clean_eating || false,
          workout: data.workout || false,
          meditation: data.meditation || false,
          noAlcohol: data.no_alcohol || false,
          reading: data.reading || false,
          stretching: data.stretching || false,
          // Extra fields stored in localStorage for now
          outside: false,
          badSleep: false,
          stressed: false,
          alcohol: false,
          unhealthy: false
        };
        // Load extra habits from localStorage
        const extraHabits = localStorage.getItem(`habits_extra_${today}`);
        if (extraHabits) {
          const extra = JSON.parse(extraHabits);
          state.habits = { ...state.habits, ...extra };
        }
      }
    }

    async function saveEntry() {
      if (!state.user) return;
      const textarea = document.getElementById('entry-content');
      if (textarea) state.content = textarea.value;
      
      const entry = {
        user_id: state.user.id,
        date: new Date().toISOString().split('T')[0],
        content: state.content,
        mood: state.mood,
        energy: state.energy,
        libido: state.libido,
        focus: state.focus,
        stress: state.stress,
        sleep_quality: state.sleep,
        habits: { ...state.habits }
      };

      let error;
      if (state.editingId) {
        const result = await supabaseClient.from('journal_entries').update(entry).eq('id', state.editingId);
        error = result.error;
      } else {
        const result = await supabaseClient.from('journal_entries').insert([entry]);
        error = result.error;
      }

      if (error) {
        alert('Fout bij opslaan: ' + error.message);
        return;
      }

      state.content = '';
      state.editingId = null;
      await loadEntries();
      showToast('‚úì Entry opgeslagen!');
      render();
    }

    async function deleteEntry(id) {
      if (!confirm('Weet je zeker dat je deze entry wilt verwijderen?')) return;
      await supabaseClient.from('journal_entries').delete().eq('id', id);
      await loadEntries();
      render();
    }

    function editEntry(entry) {
      state.editingId = entry.id;
      state.content = entry.content || '';
      state.mood = entry.mood || 7;
      state.energy = entry.energy || 7;
      state.libido = entry.libido || 7;
      state.focus = entry.focus || 7;
      state.stress = entry.stress || 4;
      state.sleep = entry.sleep_quality || 7;
      state.journalTab = 'new';
      render();
    }

    async function startRetention() {
      if (!state.user) return;
      const { data, error } = await supabaseClient.from('retention').insert([{
        user_id: state.user.id,
        start_date: new Date().toISOString().split('T')[0],
        is_active: true
      }]).select().single();
      if (!error) {
        state.retentionStreak = data;
        showToast('üî• Streak gestart!');
        render();
      }
    }

    async function resetRetention() {
      if (!state.user || !state.retentionStreak) return;
      if (!confirm('Weet je zeker dat je je streak wilt resetten?')) return;
      
      await supabaseClient.from('retention').update({ 
        is_active: false, 
        end_date: new Date().toISOString().split('T')[0],
        streak_days: getRetentionDays()
      }).eq('id', state.retentionStreak.id);
      
      state.retentionStreak = null;
      render();
    }

    async function toggleHabit(habit) {
      state.habits[habit] = !state.habits[habit];
      render();
      
      if (!state.user) return;
      const today = new Date().toISOString().split('T')[0];
      
      // Core habits for database
      const coreHabits = ['coldShower', 'sunlight', 'cleanEating', 'workout', 'meditation', 'noAlcohol', 'reading', 'stretching'];
      const extraHabits = ['outside', 'badSleep', 'stressed', 'alcohol', 'unhealthy'];
      
      // Save core habits to database
      const habitData = {
        user_id: state.user.id,
        date: today,
        cold_shower: state.habits.coldShower,
        sunlight: state.habits.sunlight,
        clean_eating: state.habits.cleanEating,
        workout: state.habits.workout,
        meditation: state.habits.meditation,
        no_alcohol: state.habits.noAlcohol,
        reading: state.habits.reading,
        stretching: state.habits.stretching
      };
      
      await supabaseClient.from('daily_habits').upsert(habitData, { onConflict: 'user_id,date' });
      
      // Save extra habits to localStorage
      const extraData = {};
      extraHabits.forEach(h => extraData[h] = state.habits[h]);
      localStorage.setItem(`habits_extra_${today}`, JSON.stringify(extraData));
    }

    // ============================================
    // RENDER: AUTH
    // ============================================
    let authMode = 'login';

    function renderAuth() {
      return `
        <div class="auth-container">
          <div class="auth-box">
            <div style="text-align: center; margin-bottom: 32px;">
              <span class="logo">PRIMAL</span><span class="logo logo-accent">FORGED</span>
            </div>
            <div class="auth-title">Welkom</div>
            <div class="auth-subtitle">Login of maak een account aan</div>
            <div id="auth-error" class="auth-error" style="display: none;"></div>
            <div id="auth-success" class="auth-success" style="display: none;"></div>
            <form id="auth-form" onsubmit="handleAuth(event)">
              <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
              <input type="password" id="auth-password" class="auth-input" placeholder="Wachtwoord" required minlength="6">
              <button type="submit" class="auth-btn" id="auth-submit">Inloggen</button>
            </form>
            <div class="auth-switch">
              <span id="auth-switch-text">Nog geen account?</span>
              <a id="auth-switch-link" onclick="toggleAuthMode()">Registreren</a>
            </div>
          </div>
        </div>
      `;
    }

    function toggleAuthMode() {
      authMode = authMode === 'login' ? 'signup' : 'login';
      document.getElementById('auth-submit').textContent = authMode === 'login' ? 'Inloggen' : 'Registreren';
      document.getElementById('auth-switch-text').textContent = authMode === 'login' ? 'Nog geen account?' : 'Al een account?';
      document.getElementById('auth-switch-link').textContent = authMode === 'login' ? 'Registreren' : 'Inloggen';
    }

    async function handleAuth(e) {
      e.preventDefault();
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      const errorEl = document.getElementById('auth-error');
      const successEl = document.getElementById('auth-success');
      const submitBtn = document.getElementById('auth-submit');
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Even geduld...';
      
      try {
        if (authMode === 'signup') {
          await signUp(email, password);
          successEl.textContent = 'Check je email om je account te bevestigen!';
          successEl.style.display = 'block';
        } else {
          await signIn(email, password);
        }
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = authMode === 'login' ? 'Inloggen' : 'Registreren';
    }

    // ============================================
    // RENDER: DASHBOARD
    // ============================================
    function renderDashboard() {
      const quote = getDailyQuote();
      const retDays = getRetentionDays();
      const phase = getRetentionPhase(retDays);
      const habitsCount = getHabitsCompleted();
      
      return `
        <div class="page-header">
          <div class="greeting">${getGreeting()}, Strijder</div>
          <div class="greeting-sub">Dag ${state.entries.length > 0 ? getJournalStreak() : 1} van je transformatie</div>
        </div>
        
        <div class="quote-card">
          <div class="quote-text">"${quote.text}"</div>
          <div class="quote-author">‚Äî ${quote.author}</div>
        </div>
        
        <div class="stats">
          <div class="stat">
            <div class="stat-value" style="color: ${phase.color}">${retDays}</div>
            <div class="stat-label">Retention</div>
          </div>
          <div class="stat">
            <div class="stat-value">${state.entries.length}</div>
            <div class="stat-label">Entries</div>
          </div>
          <div class="stat">
            <div class="stat-value">${getPositiveHabitsCount()}/9</div>
            <div class="stat-label">Habits</div>
          </div>
          <div class="stat">
            <div class="stat-value" style="color: ${getColor(parseFloat(getAverageMood()) || 5)}">${getAverageMood()}</div>
            <div class="stat-label">Mood</div>
          </div>
        </div>
        
        <div class="card">
          <label class="label">‚úÖ Positieve Gewoontes <span style="color: #525252; font-weight: 400;">(lang drukken = info)</span></label>
          <div class="habit-grid">
            ${Object.entries(habitConfig).filter(([k, c]) => c.positive).map(([key, cfg]) => `
              <button class="habit ${state.habits[key] ? 'done' : ''}" 
                onmousedown="startHabitPress('${key}')" 
                onmouseup="endHabitPress('${key}')" 
                onmouseleave="cancelHabitPress()"
                ontouchstart="startHabitPress('${key}')" 
                ontouchend="endHabitPress('${key}')"
                ontouchcancel="cancelHabitPress()">
                <span class="habit-icon">${cfg.icon}</span>
                <span class="habit-label">${cfg.label}</span>
              </button>
            `).join('')}
          </div>
        </div>
        
        <div class="card">
          <label class="label">‚ö†Ô∏è Vandaag Gebeurd</label>
          <div class="habit-grid">
            ${Object.entries(habitConfig).filter(([k, c]) => !c.positive).map(([key, cfg]) => `
              <button class="habit ${state.habits[key] ? 'done negative' : ''}" 
                onmousedown="startHabitPress('${key}')" 
                onmouseup="endHabitPress('${key}')" 
                onmouseleave="cancelHabitPress()"
                ontouchstart="startHabitPress('${key}')" 
                ontouchend="endHabitPress('${key}')"
                ontouchcancel="cancelHabitPress()">
                <span class="habit-icon">${cfg.icon}</span>
                <span class="habit-label">${cfg.label}</span>
              </button>
            `).join('')}
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <button class="btn btn-secondary btn-small" onclick="setSection('journal')">+ Journal</button>
          <button class="btn btn-secondary btn-small" onclick="setSection('retention')">Retention ‚Üí</button>
        </div>
        
        ${state.showHabitModal ? renderHabitModal() : ''}
      `;
    }
    
    function renderHabitModal() {
      const habit = habitConfig[state.showHabitModal];
      if (!habit) return '';
      
      return `
        <div class="modal-overlay" onclick="if(event.target === this) { state.showHabitModal = null; render(); }">
          <div class="modal">
            <div class="habit-modal-icon">${habit.icon}</div>
            <div class="modal-title habit" style="text-align: center;">${habit.title}</div>
            
            <div class="habit-modal-duration">‚è±Ô∏è ${habit.duration}</div>
            
            <div class="modal-step habit">
              <div class="modal-step-title">WAT</div>
              <div class="modal-step-text">${habit.what}</div>
            </div>
            
            <div class="modal-step habit">
              <div class="modal-step-title">HOE</div>
              <div class="modal-step-text">${habit.how}</div>
            </div>
            
            <div class="modal-step habit">
              <div class="modal-step-title">WAAROM</div>
              <div class="modal-step-text">${habit.why}</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
              <button class="btn btn-secondary" onclick="state.showHabitModal = null; render();">Sluiten</button>
              <button class="btn btn-primary" onclick="toggleHabit('${state.showHabitModal}'); state.showHabitModal = null; render();">
                ${state.habits[state.showHabitModal] ? '‚úì Gedaan' : 'Afvinken'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // RENDER: RETENTION
    // ============================================
    function renderRetention() {
      const days = getRetentionDays();
      const phase = getRetentionPhase(days);
      const nextMilestone = getNextMilestone(days);
      const progress = nextMilestone ? (days / nextMilestone.days) * 100 : 100;
      
      return `
        <div class="page-header">
          <div class="page-sub">Discipline</div>
          <div class="page-title">Retention</div>
        </div>
        
        ${state.retentionStreak ? `
          <div class="card" style="text-align: center;">
            <div class="streak-big">
              <div class="streak-number" style="color: ${phase.color}">${days}</div>
              <div class="streak-label">Dagen Streak</div>
            </div>
            <div class="phase-indicator" style="background: ${phase.color}20; border: 1px solid ${phase.color}50;">
              <div class="phase-name" style="color: ${phase.color}">Fase: ${phase.name}</div>
            </div>
            ${nextMilestone && days < nextMilestone.days ? `
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%; background: ${phase.color};"></div>
              </div>
              <div style="font-size: 10px; color: #525252; margin-top: 8px;">
                Nog ${nextMilestone.days - days} dagen tot ${nextMilestone.title}
              </div>
            ` : ''}
          </div>
          
          <button class="emergency-btn" onclick="state.showEmergencyModal = true; render();">
            üö® NOODPROTOCOL
          </button>
          
          <div class="card">
            <label class="label">Milestones</label>
            ${retentionMilestones.map(m => `
              <div class="milestone ${days >= m.days ? 'achieved' : ''}">
                <div class="milestone-day">${m.days}</div>
                <div>
                  <div class="milestone-title">${days >= m.days ? '‚úì ' : ''}${m.title}</div>
                  <div class="milestone-desc">${m.desc}</div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="card">
            <label class="label">Urge Technieken</label>
            <div class="urge-grid">
              ${urges.map(u => `
                <div class="urge" title="${u.desc}">
                  <span class="urge-icon">${u.icon}</span>
                  <span class="urge-label">${u.label}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <button class="btn btn-secondary" style="width: 100%;" onclick="resetRetention()">Reset Streak</button>
        ` : `
          <div class="card" style="text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üî•</div>
            <div style="font-size: 14px; color: #a3a3a3; margin-bottom: 24px;">
              Begin je retention journey en track je voortgang.
            </div>
            <button class="btn btn-primary" onclick="startRetention()">Start Streak</button>
          </div>
        `}
        
        ${state.showEmergencyModal ? renderEmergencyModal() : ''}
      `;
    }

    function renderEmergencyModal() {
      return `
        <div class="modal-overlay" onclick="if(event.target === this) { state.showEmergencyModal = false; render(); }">
          <div class="modal">
            <div class="modal-title">üö® NOODPROTOCOL</div>
            <p style="font-size: 12px; color: #a3a3a3; margin-bottom: 16px;">
              Je hebt een urge. Dat is normaal. Volg deze stappen:
            </p>
            <div class="modal-step">
              <div class="modal-step-title">1. ADEM</div>
              <div class="modal-step-text">4 tellen in, 4 tellen vast, 4 tellen uit. Herhaal 5x.</div>
            </div>
            <div class="modal-step">
              <div class="modal-step-title">2. VERLAAT</div>
              <div class="modal-step-text">Ga nu naar een andere kamer. Nu.</div>
            </div>
            <div class="modal-step">
              <div class="modal-step-title">3. KOUD WATER</div>
              <div class="modal-step-text">Spoel je gezicht met ijskoud water of neem een koude douche.</div>
            </div>
            <div class="modal-step">
              <div class="modal-step-title">4. BEWEEG</div>
              <div class="modal-step-text">20 push-ups. 20 squats. Nu. Geen excuses.</div>
            </div>
            <div class="modal-step">
              <div class="modal-step-title">5. HERINNER</div>
              <div class="modal-step-text">Je bent ${getRetentionDays()} dagen sterk. Gooi dat niet weg voor 5 seconden.</div>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="state.showEmergencyModal = false; render();">
              Ik heb dit üí™
            </button>
          </div>
        </div>
      `;
    }

    // ============================================
    // RENDER: JOURNAL
    // ============================================
    function renderJournal() {
      return `
        <div class="page-header">
          <div class="page-sub">Reflectie</div>
          <div class="page-title">Journal</div>
        </div>
        
        <div class="stats">
          <div class="stat">
            <div class="stat-value">${state.entries.length}</div>
            <div class="stat-label">Entries</div>
          </div>
          <div class="stat">
            <div class="stat-value" style="color: ${getColor(parseFloat(getAverageMood()) || 5)}">${getAverageMood()}</div>
            <div class="stat-label">Mood</div>
          </div>
          <div class="stat">
            <div class="stat-value">${getJournalStreak()}</div>
            <div class="stat-label">Streak</div>
          </div>
          <div class="stat">
            <div class="stat-value">${getAverageEnergy()}</div>
            <div class="stat-label">Energie</div>
          </div>
        </div>
        
        <div class="tabs">
          <button class="tab ${state.journalTab === 'new' ? 'active' : ''}" onclick="setJournalTab('new')">Nieuwe Entry</button>
          <button class="tab ${state.journalTab === 'history' ? 'active' : ''}" onclick="setJournalTab('history')">Geschiedenis</button>
          <button class="tab ${state.journalTab === 'patterns' ? 'active' : ''}" onclick="setJournalTab('patterns')">Patronen</button>
        </div>
        
        ${state.journalTab === 'new' ? renderNewEntry() : ''}
        ${state.journalTab === 'history' ? renderHistory() : ''}
        ${state.journalTab === 'patterns' ? renderPatterns() : ''}
      `;
    }

    function renderNewEntry() {
      const prompt = getDailyPrompt();
      return `
        ${state.editingId ? `
          <div class="card card-accent">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 12px; color: #7f1d1d;">‚úèÔ∏è Je bewerkt een entry</span>
              <button onclick="state.editingId = null; state.content = ''; render();" style="background: transparent; border: none; color: #525252; font-size: 11px; cursor: pointer;">Annuleer</button>
            </div>
          </div>
        ` : `
          <div class="prompt">
            <div class="prompt-label">üìù Vraag van vandaag</div>
            <div class="prompt-text">"${prompt}"</div>
          </div>
        `}
        
        <div class="card">
          <label class="label">Schrijf je gedachten</label>
          <textarea class="textarea" id="entry-content" placeholder="Wat houdt je bezig?">${state.content}</textarea>
        </div>
        
        <div class="card">
          <label class="label">Hoe voel je je?</label>
          ${['mood', 'energy', 'libido', 'focus', 'stress', 'sleep'].map(key => {
            const icons = { mood: 'üòä', energy: '‚ö°', libido: 'üî•', focus: 'üß†', stress: 'üò∞', sleep: 'üò¥' };
            const labels = { mood: 'Stemming', energy: 'Energie', libido: 'Libido', focus: 'Focus', stress: 'Stress', sleep: 'Slaap' };
            const value = state[key];
            const isStress = key === 'stress';
            return `
              <div class="slider-group">
                <div class="slider-header">
                  <span class="slider-label">${icons[key]} ${labels[key]}</span>
                  <span class="slider-value" id="${key}-value" style="color: ${getColor(value, isStress)}">${value}</span>
                </div>
                <input type="range" class="slider ${isStress ? 'slider-stress' : ''}" min="1" max="10" value="${value}" oninput="updateSlider('${key}', this.value)">
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="card">
          <label class="label">Vandaag's Habits</label>
          <div class="info-box" style="margin-bottom: 12px;">
            <div class="info-text">üí° Habits worden automatisch gekoppeld aan je journal entry</div>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${Object.entries(habitConfig).map(([key, cfg]) => `
              <span style="padding: 6px 10px; font-size: 11px; background: ${state.habits[key] ? (cfg.positive ? 'rgba(34,197,94,0.1)' : 'rgba(234,179,8,0.1)') : '#0a0a0a'}; border: 1px solid ${state.habits[key] ? (cfg.positive ? '#22c55e' : '#eab308') : '#1c1c1c'}; color: ${state.habits[key] ? (cfg.positive ? '#22c55e' : '#eab308') : '#525252'};">
                ${cfg.icon} ${cfg.label}
              </span>
            `).join('')}
          </div>
          <div style="margin-top: 12px; font-size: 11px; color: #525252;">
            <a href="#" onclick="setSection('dashboard'); return false;" style="color: #7f1d1d;">‚Üí Habits aanpassen op Dashboard</a>
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between;">
          <button class="btn btn-secondary" onclick="state.content = ''; render();">Reset</button>
          <button class="btn btn-primary" onclick="saveEntry()">${state.editingId ? 'Bijwerken' : 'Opslaan'}</button>
        </div>
      `;
    }

    function renderHistory() {
      if (state.entries.length === 0) {
        return `<div class="empty">Nog geen entries. Begin met schrijven!</div>`;
      }
      return state.entries.map(entry => `
        <div class="entry">
          <div class="entry-date">${formatDate(entry.date)}</div>
          <div class="entry-scores">
            <span class="entry-score" style="color: ${getColor(entry.mood)}">üòä ${entry.mood}</span>
            <span class="entry-score" style="color: ${getColor(entry.energy)}">‚ö° ${entry.energy}</span>
            <span class="entry-score" style="color: ${getColor(entry.libido)}">üî• ${entry.libido}</span>
            <span class="entry-score" style="color: ${getColor(entry.focus)}">üß† ${entry.focus}</span>
          </div>
          ${entry.content ? `<div class="entry-content">${entry.content.substring(0, 200)}${entry.content.length > 200 ? '...' : ''}</div>` : ''}
          ${entry.habits ? `
            <div class="entry-habits">
              ${Object.entries(entry.habits).filter(([k, v]) => v && habitConfig[k]).map(([k, v]) => {
                const cfg = habitConfig[k];
                return `<span class="entry-habit" style="background: ${cfg.positive ? 'rgba(34,197,94,0.1)' : 'rgba(234,179,8,0.1)'}; color: ${cfg.positive ? '#22c55e' : '#eab308'};">${cfg.icon} ${cfg.label}</span>`;
              }).join('')}
            </div>
          ` : ''}
          <div class="entry-actions">
            <button class="entry-action" onclick='editEntry(${JSON.stringify(entry)})'>‚úèÔ∏è Bewerken</button>
            <button class="entry-action delete" onclick="deleteEntry('${entry.id}')">üóëÔ∏è Verwijderen</button>
          </div>
        </div>
      `).join('');
    }

    function renderPatterns() {
      const insights = getInsights();
      const entriesWithHabits = state.entries.filter(e => e.habits && Object.keys(e.habits).length > 0);
      
      let html = `
        <div class="info-box">
          <div class="info-title">üìä Hoe werkt dit?</div>
          <div class="info-text">De app analyseert welke habits correleren met hogere of lagere mood/energie scores. Hoe meer data, hoe accurater de patronen.</div>
        </div>
      `;
      
      if (entriesWithHabits.length < 3) {
        html += `<div class="empty">Log minimaal 3 entries MET habits om patronen te zien.<br><br>üí° Tip: Vink habits af op Dashboard v√≥√≥rdat je een journal entry maakt!</div>`;
      } else if (insights.length === 0) {
        html += `<div class="empty">Nog geen duidelijke patronen gevonden.<br><br>Je hebt ${entriesWithHabits.length} entries met habits. Blijf consistent loggen voor betere inzichten!</div>`;
      } else {
        html += insights.map(insight => `
          <div class="insight ${insight.positive ? 'insight-positive' : 'insight-negative'}">
            <div class="insight-icon">${insight.icon}</div>
            <div>
              <div class="insight-title">${insight.title}</div>
              <div class="insight-text">${insight.text}</div>
            </div>
          </div>
        `).join('');
      }
      return html;
    }

    // ============================================
    // RENDER: MORE
    // ============================================
    function renderMore() {
      return `
        <div class="page-header">
          <div class="page-sub">Extra</div>
          <div class="page-title">Meer</div>
        </div>
        
        <div class="card">
          <label class="label">Komt binnenkort</label>
          <div style="color: #525252; font-size: 12px;">
            <p style="margin-bottom: 12px;">‚Ä¢ Doelen tracker</p>
            <p style="margin-bottom: 12px;">‚Ä¢ Lichaamsmetingen</p>
            <p style="margin-bottom: 12px;">‚Ä¢ Voeding logboek</p>
            <p style="margin-bottom: 12px;">‚Ä¢ Supplementen</p>
            <p style="margin-bottom: 12px;">‚Ä¢ Slaap analyse</p>
            <p style="margin-bottom: 12px;">‚Ä¢ Training programma's</p>
            <p style="margin-bottom: 12px;">‚Ä¢ Bloedwaarden</p>
            <p>‚Ä¢ Challenges</p>
          </div>
        </div>
        
        <div class="card">
          <label class="label">Account</label>
          <div style="font-size: 12px; color: #525252; margin-bottom: 16px;">${state.user.email}</div>
          <button class="btn btn-secondary" style="width: 100%;" onclick="signOut()">Uitloggen</button>
        </div>
      `;
    }

    // ============================================
    // RENDER: APP
    // ============================================
    function renderApp() {
      return `
        <div class="app-header">
          <div>
            <span class="logo">PRIMAL</span><span class="logo logo-accent">FORGED</span>
          </div>
          <div class="user-menu">
            <span class="user-email">${state.user.email}</span>
            <button class="logout-btn" onclick="signOut()">Logout</button>
          </div>
        </div>
        
        <div id="toast" class="toast"></div>
        
        <div class="container">
          ${state.activeSection === 'dashboard' ? renderDashboard() : ''}
          ${state.activeSection === 'journal' ? renderJournal() : ''}
          ${state.activeSection === 'retention' ? renderRetention() : ''}
          ${state.activeSection === 'more' ? renderMore() : ''}
        </div>
        
        <nav class="nav">
          <button class="nav-item ${state.activeSection === 'dashboard' ? 'active' : ''}" onclick="setSection('dashboard')">
            <span class="nav-icon">üìä</span>Dashboard
          </button>
          <button class="nav-item ${state.activeSection === 'journal' ? 'active' : ''}" onclick="setSection('journal')">
            <span class="nav-icon">üìù</span>Journal
          </button>
          <button class="nav-item ${state.activeSection === 'retention' ? 'active' : ''}" onclick="setSection('retention')">
            <span class="nav-icon">üî•</span>Retention
          </button>
          <button class="nav-item ${state.activeSection === 'more' ? 'active' : ''}" onclick="setSection('more')">
            <span class="nav-icon">‚ö°</span>Meer
          </button>
        </nav>
      `;
    }

    function render() {
      const app = document.getElementById('app');
      if (state.loading) {
        app.innerHTML = '<div class="loading"><span class="loading-text">Laden...</span></div>';
        return;
      }
      if (!state.user) {
        app.innerHTML = renderAuth();
        return;
      }
      app.innerHTML = renderApp();
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================
    function setSection(section) {
      state.activeSection = section;
      render();
    }

    function setJournalTab(tab) {
      state.journalTab = tab;
      render();
    }

    function updateSlider(key, value) {
      state[key] = parseInt(value);
      const el = document.getElementById(`${key}-value`);
      if (el) {
        el.textContent = value;
        el.style.color = getColor(parseInt(value), key === 'stress');
      }
    }

    // Long-press for habits
    let habitPressTimer = null;
    let habitPressStart = null;
    const LONG_PRESS_DURATION = 500; // ms

    function startHabitPress(habitKey) {
      habitPressStart = Date.now();
      habitPressTimer = setTimeout(() => {
        // Long press - show modal
        state.showHabitModal = habitKey;
        render();
        habitPressTimer = null;
      }, LONG_PRESS_DURATION);
    }

    function endHabitPress(habitKey) {
      if (habitPressTimer) {
        // Short press - toggle habit
        clearTimeout(habitPressTimer);
        habitPressTimer = null;
        toggleHabit(habitKey);
      }
    }

    function cancelHabitPress() {
      if (habitPressTimer) {
        clearTimeout(habitPressTimer);
        habitPressTimer = null;
      }
    }

    // ============================================
    // INIT
    // ============================================
    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      
      if (session) {
        state.user = session.user;
        await Promise.all([loadEntries(), loadRetention(), loadHabits()]);
      }
      
      state.loading = false;
      render();
      
      supabaseClient.auth.onAuthStateChange(async (event, session) => {
        if (session) {
          state.user = session.user;
          await Promise.all([loadEntries(), loadRetention(), loadHabits()]);
        } else {
          state.user = null;
          state.entries = [];
          state.retentionStreak = null;
        }
        render();
      });
    }

    init();
  </script>
</body>
</html>
